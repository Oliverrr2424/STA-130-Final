

```{r}
#packages
library(rpart)
library(partykit)
```


```{r}
#classification tree

## I uh, which do we do? second one needs pruning

tree_model_1 <- rpart(continent ~ income_group, (data = full_merged))
plot(as.party(tree_model_1),gp=gpar(cex=0.9),type="simple")

tree_model_2 <- rpart(continent ~ income_group + index_score, (data = full_merged))
plot(as.party(tree_model_2),gp=gpar(cex=0.6),type="simple", method="class")
```


```{r}
# Scatter plot with linear regression lines
full_merged |> ggplot(aes(y=index_score, x=income_score))+geom_point()+ facet_wrap(~continent) +geom_smooth(method ="lm", se=FALSE) + labs(title= 'Divided into continents')
full_merged |> ggplot(aes(y=index_score, x=income_score, color = continent))+geom_point() +geom_smooth(method ="lm", se=FALSE) + labs(title= 'World Total')
```

```{r}
#proportion variable

proportions <- full_merged %>%
  group_by(continent) %>%
  summarise(proportion_high_income = mean(wbi_income_group == "High income"))

glimpse(proportions)

```


**Distribution of income levels visualizations (Bars and pies)**

```{r}
# Pie chart of the world
full_merged %>% 
  group_by(income_group) %>%
  summarise(n=n()) %>%
  ggplot(aes(x="", y=n, fill=income_group)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void()

# Bar charts of the proportions
full_merged_bars <- full_merged
full_merged_bars$income_group <- factor(full_merged$income_group, levels=c('High income', 'Upper middle income', 'Lower middle income', 'Low income'))



bar_proportions <- full_merged %>%
  group_by(continent, income_group) %>% 
  summarise(n=n())

bar_proportions <- tibble(bar_proportions %>%
  mutate(continent_count = 
             case_when(
               continent == 'Africa' ~ 43,
               continent == 'Americas' ~ 27,
               continent == 'Asia' ~ 42,
               continent == 'Europe' ~ 39,
               continent == 'Oceania' ~ 4
             ), 
         income_count = 
           case_when(
             income_group == 'Low income' ~ 22,
             income_group == 'Lower middle income' ~ 41,
             income_group == 'Upper middle income' ~ 43,
             income_group == 'High income' ~ 49,
           )) %>%
  summarise(n=n, income_group = income_group, 'proportion/continent' = n/continent_count, 'proportion/world total' = n/155, continent_count = continent_count, planet = 'world', income_count = income_count))

bar_proportions$income_group <- factor(bar_proportions$income_group, levels=c('High income', 'Upper middle income', 'Lower middle income', 'Low income'))

ggplot(data = bar_proportions,aes(x= planet, fill = income_group, y=n/155)) +
 geom_bar(position = 'stack', stat='identity') +
  labs(x = 'World', title = 'World proportion', y = 'Percent of total') + scale_y_continuous(labels = scales::percent)

  
ggplot(data = bar_proportions, aes(x= continent, fill = income_group,  y= n/continent_count)) +
  geom_bar(position = 'stack', stat='identity') +
  labs(x = 'Continents', y= 'Percentage of continent', title = "Continents proportions of income levels") + scale_y_continuous(labels = scales::percent)

ggplot(data = bar_proportions, aes(x= continent, fill = income_group,  y= n)) +
  geom_bar(position = 'stack', stat='identity') +
  labs(x = 'Continents', y= 'Count', title = "Income levels distribution across continents")

ggplot(data = bar_proportions, aes(x= income_group, fill = continent,  y= n/income_count)) +
  geom_bar(position = 'stack', stat='identity') +
  labs(x = 'Continents', y= 'Percentage of income level', title = "Income levels distribution across continents") + scale_y_continuous(labels = scales::percent)

ggplot(data = bar_proportions, aes(x= income_group, fill = continent,  y= n)) +
  geom_bar(position = 'stack', stat='identity') +
  labs(x = 'Continents', y= 'Count', title = "Income levels counts across continents") 


head(bar_proportions)
```


```{r}
#data splitting
set.seed(130)

frac <- 0.8

full_merged_train <- full_merged %>% sample_frac(frac)
full_merged_test <- full_merged %>% anti_join(full_merged_train, by = "incoem_group")
```
